<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ¹å²¸ç™º äº¤é€šè²»è¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.5em;
      margin-bottom: 1em;
    }

    label,
    select,
    input {
      margin: 0.5em 0;
    }

    .row {
      margin-bottom: 1em;
    }

    .facility {
      color: #555;
      font-size: 0.9em;
    }

    button {
      padding: 0.5em 1em;
      font-size: 1em;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }

    button:hover {
      background: #0056b3;
    }

    .route-item {
      padding: 0.5em;
      margin: 0.5em 0;
      background: #f8f9fa;
      border-left: 3px solid #007bff;
    }

    @media (max-width: 600px) {
      body {
        padding: 0.5em;
      }

      h1 {
        font-size: 1.2em;
      }
    }
  </style>
  <!-- PapaParseã®CDNï¼ˆCSVãƒ‘ãƒ¼ã‚µï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>

<body>
  <h1>æ ¹å²¸ç™º äº¤é€šè²»è¨ˆç®—ãƒ„ãƒ¼ãƒ«</h1>

  <!-- ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
  <div class="row">
    <button onclick="toggleAdmin()" style="background: #6c757d;">ğŸ”§ ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</button>
  </div>

  <!-- ç®¡ç†UIï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
  <div id="adminPanel"
    style="display: none; border: 2px solid #28a745; padding: 1em; margin: 1em 0; background: #f0fff4; border-radius: 8px;">
    <h3 style="margin-top: 0;">é§…ã®è¿½åŠ ãƒ»å‰Šé™¤</h3>
    <div class="row">
      <label>è¿½åŠ ã™ã‚‹é§…åï¼š
        <input type="text" id="newStationInput" placeholder="ä¾‹: å“å·">
      </label>
      <button onclick="addStationViaGAS()" style="background: #28a745;">â• é§…ã‚’è¿½åŠ </button>
      <span id="addStatus" style="margin-left: 1em; font-weight: bold;"></span>
    </div>
    <div class="row" style="margin-top: 1em;">
      <strong>ç™»éŒ²æ¸ˆã¿é§…ä¸€è¦§:</strong>
      <div id="stationList" style="margin-top: 0.5em;"></div>
    </div>
  </div>

  <div class="row">
    <label>åˆ°ç€é§…ï¼š
      <select id="toStation"></select>
    </label>
  </div>
  <div class="row">
    <label>ç‰‡é“é‡‘é¡ï¼ˆå††ï¼‰ï¼š
      <input type="number" id="fareInput" readonly>
    </label>
    <label>å¾€å¾©é‡‘é¡ï¼ˆå††ï¼‰ï¼š
      <input type="number" id="roundFareInput" readonly>
    </label>
  </div>
  <div class="row facility" id="facilityInfo"></div>

  <div class="row">
    <button onclick="addRoute()">åŒºé–“ã‚’è¿½åŠ </button>
  </div>
  <div id="routes"></div>
  <div class="row">
    <strong>åˆè¨ˆï¼ˆç‰‡é“ï¼‰ï¼š<span id="totalFare">0</span> å††ã€€
      åˆè¨ˆï¼ˆå¾€å¾©ï¼‰ï¼š<span id="totalRoundFare">0</span> å††</strong>
  </div>

  <script>
    // Google Apps Script ãƒ‡ãƒ—ãƒ­ã‚¤URL
    const GAS_API_URL = "YOUR_GAS_DEPLOYMENT_URL_HERE";

    let fareData = [];
    let routeList = [];

    // Google Sheetså…¬é–‹CSVã‚’ç›´æ¥èª­ã¿è¾¼ã¿
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGEHOeXmRZ9ozOakzu76h3e2c8TaA7e8p8wTTpRy_NkwoKhqBNXk1joES3kfZR9xWOp-u2o3CVJ8nx/pub?gid=0&single=true&output=csv";

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function (results) {
        fareData = results.data.map(row => ({
          to: row["åˆ°ç€"],
          fare: Number(row["ç‰‡é“"]),
          facility: (row["ä¸»è¦ãªæ–½è¨­"] || "").replace(/^ï¼ˆ|ï¼‰$/g, '')
        })).filter(item => item.to && !isNaN(item.fare));

        setupSelect();
      },
      error: function (error) {
        console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    });

    function setupSelect() {
      const select = document.getElementById('toStation');
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      fareData.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.to;
        opt.textContent = `${item.to}ï¼ˆ${item.facility}ï¼‰`;
        select.appendChild(opt);
      });
      const optOther = document.createElement('option');
      optOther.value = 'other';
      optOther.textContent = 'ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰';
      select.appendChild(optOther);

      select.onchange = showFare;
    }

    function showFare() {
      const select = document.getElementById('toStation');
      const val = select.value;
      const input = document.getElementById('fareInput');
      const roundInput = document.getElementById('roundFareInput');
      const facilityDiv = document.getElementById('facilityInfo');
      if (val === "other") {
        input.value = "";
        input.readOnly = false;
        roundInput.value = "";
        roundInput.readOnly = false;
        facilityDiv.textContent = "";
      } else {
        const found = fareData.find(item => item.to === val);
        if (found) {
          input.value = found.fare;
          input.readOnly = true;
          roundInput.value = found.fare * 2;
          roundInput.readOnly = true;
          facilityDiv.textContent = `ä¸»è¦ãªæ–½è¨­ï¼š${found.facility}`;
        } else {
          input.value = "";
          input.readOnly = false;
          roundInput.value = "";
          roundInput.readOnly = false;
          facilityDiv.textContent = "";
        }
      }
    }

    function addRoute() {
      const select = document.getElementById('toStation');
      const station = select.value;
      let fare = parseInt(document.getElementById('fareInput').value, 10);
      let roundFare = parseInt(document.getElementById('roundFareInput').value, 10);
      if (!station || isNaN(fare) || isNaN(roundFare)) {
        alert("åˆ°ç€é§…ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const facility = (station === "other") ? "" :
        (fareData.find(item => item.to === station) || {}).facility || "";
      routeList.push({ to: station, fare: fare, roundFare: roundFare, facility: facility });
      updateRoutes();
      // ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
      select.value = "";
      document.getElementById('fareInput').value = "";
      document.getElementById('roundFareInput').value = "";
      document.getElementById('facilityInfo').textContent = "";
    }

    function updateRoutes() {
      const div = document.getElementById('routes');
      div.innerHTML = "";
      let total = 0;
      let totalRound = 0;
      routeList.forEach((item, idx) => {
        total += item.fare;
        totalRound += item.roundFare;
        const p = document.createElement('div');
        p.className = "route-item";
        p.textContent = `åŒºé–“${idx + 1}: æ ¹å²¸ â†’ ${item.to}ï¼ˆ${item.facility}ï¼‰: ç‰‡é“${item.fare}å†† / å¾€å¾©${item.roundFare}å††`;
        div.appendChild(p);
      });
      document.getElementById('totalFare').textContent = total;
      document.getElementById('totalRoundFare').textContent = totalRound;
    }

    // === ç®¡ç†æ©Ÿèƒ½ ===
    function toggleAdmin() {
      const panel = document.getElementById('adminPanel');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        loadStationList();
      } else {
        panel.style.display = 'none';
      }
    }

    async function addStationViaGAS() {
      const stationName = document.getElementById('newStationInput').value.trim();
      const statusSpan = document.getElementById('addStatus');

      if (!stationName) {
        alert('é§…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (GAS_API_URL === 'YOUR_GAS_DEPLOYMENT_URL_HERE') {
        alert('Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚\ngas/README.mdã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      statusSpan.textContent = 'å‡¦ç†ä¸­...ï¼ˆæ•°ç§’ã‹ã‹ã‚Šã¾ã™ï¼‰';
      statusSpan.style.color = 'blue';

      try {
        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          mode: 'no-cors', // CORSå›é¿ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯èª­ã‚ãªã„ãŒã€å‡¦ç†ã¯å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'addStation',
            station: stationName
          })
        });

        // no-corsã®å ´åˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒèª­ã‚ãªã„ãŸã‚ã€5ç§’å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰
        setTimeout(() => {
          statusSpan.textContent = 'âœ… å®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™...';
          statusSpan.style.color = 'green';
          setTimeout(() => location.reload(), 1500);
        }, 5000);
      } catch (error) {
        statusSpan.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
        statusSpan.style.color = 'red';
      }
    }

    async function loadStationList() {
      const listDiv = document.getElementById('stationList');
      listDiv.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';

      // å…¬é–‹CSVã‹ã‚‰é§…ä¸€è¦§ã‚’å–å¾—ï¼ˆfare Dataã‹ã‚‰é‡è¤‡é™¤å»ï¼‰
      const uniqueStations = [...new Set(fareData.map(item => item.to))];

      listDiv.innerHTML = '';
      uniqueStations.forEach(station => {
        const div = document.createElement('div');
        div.style.padding = '0.5em';
        div.style.margin = '0.3em 0';
        div.style.background = 'white';
        div.style.border = '1px solid #ddd';
        div.style.borderRadius = '4px';

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'å‰Šé™¤';
        deleteBtn.style.background = '#dc3545';
        deleteBtn.style.color = 'white';
        deleteBtn.style.padding = '0.3em 0.6em';
        deleteBtn.style.fontSize = '0.9em';
        deleteBtn.style.marginRight = '0.5em';
        deleteBtn.onclick = () => deleteStationViaGAS(station);

        div.appendChild(deleteBtn);
        div.appendChild(document.createTextNode(station));
        listDiv.appendChild(div);
      });
    }

    async function deleteStationViaGAS(stationName) {
      if (!confirm(`"${stationName}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ Google Sheetsã‹ã‚‰ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
        return;
      }

      if (GAS_API_URL === 'YOUR_GAS_DEPLOYMENT_URL_HERE') {
        alert('Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      try {
        await fetch(GAS_API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'deleteStation',
            station: stationName
          })
        });

        // 5ç§’å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰
        setTimeout(() => {
          alert('å‰Šé™¤ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
          location.reload();
        }, 3000);
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }
  </script>
</body>

</html>