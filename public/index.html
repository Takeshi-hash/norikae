<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ¹å²¸ç™º äº¤é€šè²»è¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.5em;
      margin-bottom: 1em;
    }

    label,
    select,
    input {
      margin: 0.5em 0;
    }

    .row {
      margin-bottom: 1em;
    }

    .facility {
      color: #555;
      font-size: 0.9em;
    }

    button {
      padding: 0.5em 1em;
      font-size: 1em;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }

    button:hover {
      background: #0056b3;
    }

    .route-item {
      padding: 0.5em;
      margin: 0.5em 0;
      background: #f8f9fa;
      border-left: 3px solid #007bff;
    }

    @media (max-width: 600px) {
      body {
        padding: 0.5em;
      }

      h1 {
        font-size: 1.2em;
      }
    }
  </style>
  <!-- PapaParseã®CDNï¼ˆCSVãƒ‘ãƒ¼ã‚µï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>

<body>
  <h1>æ ¹å²¸ç™º äº¤é€šè²»è¨ˆç®—ãƒ„ãƒ¼ãƒ«</h1>

  <!-- ç®¡ç†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆmacOSãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ã¿è¡¨ç¤ºï¼‰ -->
  <div class="row" id="adminButtonRow" style="display: none;">
    <button onclick="toggleAdmin()" style="background: #6c757d;">ğŸ”§ ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</button>
  </div>
  <script>
    // macOSã®ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ã¿ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    (function () {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const isDesktop = !/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      if (isMac && isDesktop) {
        document.getElementById('adminButtonRow').style.display = 'block';
      }
    })();
  </script>

  <!-- ç®¡ç†UIï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
  <div id="adminPanel"
    style="display: none; border: 2px solid #28a745; padding: 1em; margin: 1em 0; background: #f0fff4; border-radius: 8px;">
    <h3 style="margin-top: 0;">é§…ã®è¿½åŠ ãƒ»å‰Šé™¤</h3>

    <!-- ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯èµ·å‹•ãƒœã‚¿ãƒ³ -->
    <div style="margin-bottom: 1em;">
      <a href="norikae://start" onclick="return launchAdmin()"
        style="display: inline-block; background: #28a745; color: white; padding: 0.8em 1.5em; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 1.1em;">
        ğŸš€ ç®¡ç†ãƒ„ãƒ¼ãƒ«ã‚’èµ·å‹•
      </a>
      <script>
        function launchAdmin() {
          // URLã‚¹ã‚­ãƒ¼ãƒ ãŒé–‹ã‘ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ3ç§’å¾Œã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰
          const timeout = setTimeout(function () {
            alert('âš ï¸ ç®¡ç†ãƒ„ãƒ¼ãƒ«ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\nè€ƒãˆã‚‰ã‚Œã‚‹åŸå› :\nâ€¢ NorikaeApp.appãŒæœªç™»éŒ²\nâ€¢ ã“ã®Macã«é–‹ç™ºç’°å¢ƒãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ãªã„\n\nç®¡ç†è€…ã®å ´åˆã¯ã€Œæ‰‹å‹•ã§èµ·å‹•ã™ã‚‹å ´åˆã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚');
          }, 3000);
          // ãƒšãƒ¼ã‚¸é›¢è„±ï¼ˆã‚¢ãƒ—ãƒªèµ·å‹•æˆåŠŸï¼‰ã—ãŸã‚‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          window.addEventListener('blur', function () { clearTimeout(timeout); }, { once: true });
          return true; // ãƒªãƒ³ã‚¯ã‚’é€šå¸¸é€šã‚Šé–‹ã
        }
      </script>
    </div>

    <details style="margin-top: 1em; color: #666;">
      <summary style="cursor: pointer;">æ‰‹å‹•ã§èµ·å‹•ã™ã‚‹å ´åˆ</summary>
      <ol style="margin: 0.5em 0;">
        <li>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ <code>npm start</code> ã‚’å®Ÿè¡Œ</li>
        <li><a href="http://localhost:3000/admin.html" target="_blank">http://localhost:3000/admin.html</a> ã‚’é–‹ã</li>
      </ol>
      <p style="font-size: 0.9em; color: #888;">
        â€» åˆå›ã¯ <code>NorikaeApp.app</code> ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦URLã‚¹ã‚­ãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„
      </p>
    </details>
  </div>

  <div class="row" style="display: flex; gap: 10px; align-items: center;">
    <label>ä¸¦ã³é †ï¼š
      <select id="sortOrder" onchange="setupSelect()" style="padding: 4px; border-radius: 4px;">
        <option value="area">ã‚¨ãƒªã‚¢é †</option>
        <option value="name_asc">50éŸ³ï¼ˆæ˜‡é †ï¼‰</option>
        <option value="name_desc">50éŸ³ï¼ˆé™é †ï¼‰</option>
      </select>
    </label>
    <label>åˆ°ç€é§…ï¼š
      <select id="toStation" style="padding: 4px; border-radius: 4px; min-width: 200px;"></select>
    </label>
  </div>
  <div class="row">
    <label>ç‰‡é“é‡‘é¡ï¼ˆå††ï¼‰ï¼š
      <input type="number" id="fareInput" readonly>
    </label>
    <label>å¾€å¾©é‡‘é¡ï¼ˆå††ï¼‰ï¼š
      <input type="number" id="roundFareInput" readonly>
    </label>
  </div>
  <div class="row facility" id="facilityInfo"></div>

  <div class="row">
    <button onclick="addRoute()">åŒºé–“ã‚’è¿½åŠ </button>
  </div>
  <div id="routes"></div>
  <div class="row">
    <strong>åˆè¨ˆï¼ˆç‰‡é“ï¼‰ï¼š<span id="totalFare">0</span> å††ã€€
      åˆè¨ˆï¼ˆå¾€å¾©ï¼‰ï¼š<span id="totalRoundFare">0</span> å††</strong>
  </div>

  <script>
    // Google Sheets å…¬é–‹ CSV URL
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGEHOeXmRZ9ozOakzu76h3e2c8TaA7e8p8wTTpRy_NkwoKhqBNXk1joES3kfZR9xWOp-u2o3CVJ8nx/pub?gid=0&single=true&output=csv";

    let fareData = [];
    let routeList = [];

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function (results) {
        fareData = results.data.map(row => ({
          area: row["ã‚¨ãƒªã‚¢"] || 'ãã®ä»–',
          to: row["åˆ°ç€"],
          fare: Number(row["ç‰‡é“"]),
          facility: (row["ä¸»è¦ãªæ–½è¨­"] || "").replace(/^ï¼ˆ|ï¼‰$/g, '')
        })).filter(item => item.to && !isNaN(item.fare));

        setupSelect();
      },
      error: function (error) {
        console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    });

    function setupSelect() {
      const select = document.getElementById('toStation');
      const sortOrder = document.getElementById('sortOrder').value;
      const currentVal = select.value;

      const areaPriority = [
        "ä¸»è¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«",
        "æ¸‹è°·ãƒ»æ–°å®¿ãƒ»æ± è¢‹",
        "æ¸¯åŒºï¼ˆèµ¤å‚ãƒ»å…­æœ¬æœ¨ãƒ»éº»å¸ƒï¼‰",
        "åƒä»£ç”°ãƒ»ä¸­å¤®ã‚ªãƒ•ã‚£ã‚¹è¡—",
        "ä¸­å¤®ç·šãƒ»æ–‡äº¬ã‚¨ãƒªã‚¢",
        "æ¹¾å²¸ã‚¨ãƒªã‚¢",
        "ãã®ä»–"
      ];

      // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
      const sortedData = [...fareData].sort((a, b) => {
        if (sortOrder === 'area') {
          const pA = areaPriority.indexOf(a.area);
          const pB = areaPriority.indexOf(b.area);
          const weightA = pA === -1 ? 999 : pA;
          const weightB = pB === -1 ? 999 : pB;
          if (weightA !== weightB) return weightA - weightB;
          return a.to.localeCompare(b.to, 'ja');
        } else if (sortOrder === 'name_asc') {
          return a.to.localeCompare(b.to, 'ja');
        } else if (sortOrder === 'name_desc') {
          return b.to.localeCompare(a.to, 'ja');
        }
        return 0;
      });

      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      sortedData.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.to;
        opt.textContent = `${item.to}ï¼ˆ${item.facility}ï¼‰`;
        select.appendChild(opt);
      });
      const optOther = document.createElement('option');
      optOther.value = 'other';
      optOther.textContent = 'ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰';
      select.appendChild(optOther);

      // å‰å›ã®é¸æŠã‚’ç¶­æŒ
      if (currentVal) select.value = currentVal;

      select.onchange = showFare;
    }

    function showFare() {
      const select = document.getElementById('toStation');
      const val = select.value;
      const input = document.getElementById('fareInput');
      const roundInput = document.getElementById('roundFareInput');
      const facilityDiv = document.getElementById('facilityInfo');
      if (val === "other") {
        input.value = "";
        input.readOnly = false;
        roundInput.value = "";
        roundInput.readOnly = false;
        facilityDiv.textContent = "";
      } else {
        const found = fareData.find(item => item.to === val);
        if (found) {
          input.value = found.fare;
          input.readOnly = true;
          roundInput.value = found.fare * 2;
          roundInput.readOnly = true;
          facilityDiv.textContent = `ä¸»è¦ãªæ–½è¨­ï¼š${found.facility}`;
        } else {
          input.value = "";
          input.readOnly = false;
          roundInput.value = "";
          roundInput.readOnly = false;
          facilityDiv.textContent = "";
        }
      }
    }

    function addRoute() {
      const select = document.getElementById('toStation');
      const station = select.value;
      let fare = parseInt(document.getElementById('fareInput').value, 10);
      let roundFare = parseInt(document.getElementById('roundFareInput').value, 10);
      if (!station || isNaN(fare) || isNaN(roundFare)) {
        alert("åˆ°ç€é§…ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const facility = (station === "other") ? "" :
        (fareData.find(item => item.to === station) || {}).facility || "";
      routeList.push({ to: station, fare: fare, roundFare: roundFare, facility: facility });
      updateRoutes();
      // ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
      select.value = "";
      document.getElementById('fareInput').value = "";
      document.getElementById('roundFareInput').value = "";
      document.getElementById('facilityInfo').textContent = "";
    }

    function updateRoutes() {
      const div = document.getElementById('routes');
      div.innerHTML = "";
      let total = 0;
      let totalRound = 0;
      routeList.forEach((item, idx) => {
        total += item.fare;
        totalRound += item.roundFare;
        const p = document.createElement('div');
        p.className = "route-item";
        p.textContent = `åŒºé–“${idx + 1}: æ ¹å²¸ â†’ ${item.to}ï¼ˆ${item.facility}ï¼‰: ç‰‡é“${item.fare}å†† / å¾€å¾©${item.roundFare}å††`;
        div.appendChild(p);
      });
      document.getElementById('totalFare').textContent = total;
      document.getElementById('totalRoundFare').textContent = totalRound;
    }

    // === ç®¡ç†æ©Ÿèƒ½ ===
    function toggleAdmin() {
      const panel = document.getElementById('adminPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
  </script>
</body>

</html>